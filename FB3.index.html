<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Трекер доходов и расходов</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa6b2;--accent:#7dd3fc;--green:#34d399;--red:#fb7185}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#071028 0%, #071022 60%);color:#e6eef6;min-height:100vh;padding:28px}
    .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 420px;gap:20px}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    form .row{display:flex;gap:8px;margin-bottom:8px}
    input,select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:inherit;outline:none}
    input[type=number]{moz-appearance:textfield}
    input:focus, select:focus{border-color:rgba(125,211,252,0.18);box-shadow:0 0 0 4px rgba(125,211,252,0.04)}
    button{background:linear-gradient(90deg,var(--accent),#60a5fa);border:none;color:#012;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .small{font-size:13px;color:var(--muted)}
    .totals{display:flex;gap:12px;align-items:center}
    .tot{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);min-width:120px;text-align:center}
    .tot .label{font-size:12px;color:var(--muted)}
    .tot .value{font-size:18px;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;text-align:left;font-size:14px;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .inc{background:rgba(52,211,153,0.12);color:var(--green)}
    .exp{background:rgba(251,113,133,0.06);color:var(--red)}
    .actions button{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px}
    canvas{width:100%;height:220px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    footer{grid-column:1/-1;margin-top:10px;color:var(--muted);font-size:13px;text-align:center}
    @media(max-width:980px){.wrap{grid-template-columns:1fr;}.card.right{order:-1}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Трекер доходов и расходов</h1>
      <div class="small">Данные хранятся в браузере · можно экспортировать/импортировать CSV</div>
    </header>

    <!-- Main column -->
    <section class="card" aria-labelledby="addLabel">
      <h2 id="addLabel" style="margin-top:0;font-size:16px">Добавить транзакцию</h2>
      <form id="txForm" onsubmit="return false;">
        <div class="row">
          <select id="type">
            <option value="income">Доход</option>
            <option value="expense">Расход</option>
          </select>
          <input id="amount" type="number" step="0.01" placeholder="Сумма" required>
          <input id="category" type="text" placeholder="Категория (пример: еда, аренда)" required>
        </div>
        <div class="row">
          <input id="note" type="text" placeholder="Комментарий (опционально)">
          <input id="date" type="date" aria-label="Дата">
          <button id="addBtn">Добавить</button>
        </div>
        <div class="small muted">Подсказка: используйте отрицательные суммы не нужно — выбирайте тип.</div>
      </form>

      <div style="margin-top:14px;display:flex;justify-content:space-between;align-items:center">
        <div class="controls">
          <label class="small muted">Показать: <select id="filterType"><option value="all">Все</option><option value="income">Только доходы</option><option value="expense">Только расходы</option></select></label>
          <label class="small muted">Месяц: <input id="filterMonth" type="month"></label>
        </div>
        <div class="actions">
          <button id="exportBtn">Экспорт CSV</button>
          <button id="importBtn">Импорт CSV</button>
          <button id="clearBtn">Очистить</button>
          <input id="fileInput" type="file" accept="text/csv" style="display:none">
        </div>
      </div>

      <div style="margin-top:12px;">
        <table id="txTable" aria-live="polite">
          <thead>
            <tr><th>Дата</th><th>Сумма</th><th>Категория</th><th>Комментарий</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Right column -->
    <aside class="card right">
      <h3 style="margin-top:0">Итоги</h3>
      <div class="totals" style="margin-bottom:12px">
        <div class="tot"><div class="label">Доход</div><div id="totalIncome" class="value">0</div></div>
        <div class="tot"><div class="label">Расход</div><div id="totalExpense" class="value">0</div></div>
        <div class="tot"><div class="label">Баланс</div><div id="balance" class="value">0</div></div>
      </div>

      <div>
        <h4 style="margin:6px 0">По категориям</h4>
        <canvas id="pie" role="img" aria-label="Диаграмма расходов и доходов по категориям"></canvas>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:6px 0">Быстрые отчёты</h4>
        <div class="small muted">Показывает суммы за выбранный месяц (если нет — за все данные)</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="last7">7 дн.</button>
          <button id="last30">30 дн.</button>
          <button id="thisMonth">Этот мес.</button>
        </div>
      </div>
    </aside>

    <footer>Подсказка: данные внешне не шифруются. Для совместного использования экспортируй CSV.</footer>
  </div>

  <script>
    // --- Простой трекер с localStorage ---
    const STORAGE_KEY = 'simple_finances_v1';
    let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    // DOM
    const form = document.getElementById('txForm');
    const addBtn = document.getElementById('addBtn');
    const typeEl = document.getElementById('type');
    const amountEl = document.getElementById('amount');
    const categoryEl = document.getElementById('category');
    const noteEl = document.getElementById('note');
    const dateEl = document.getElementById('date');
    const tableBody = document.querySelector('#txTable tbody');
    const totalIncomeEl = document.getElementById('totalIncome');
    const totalExpenseEl = document.getElementById('totalExpense');
    const balanceEl = document.getElementById('balance');
    const filterType = document.getElementById('filterType');
    const filterMonth = document.getElementById('filterMonth');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const clearBtn = document.getElementById('clearBtn');
    const fileInput = document.getElementById('fileInput');
    const pieCanvas = document.getElementById('pie');

    function save(){localStorage.setItem(STORAGE_KEY, JSON.stringify(data));}

    function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}

    function addTransaction(tx){data.unshift(tx); save(); render();}

    function formatNum(n){return (Math.round(n*100)/100).toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2})}

    function render(){
      // filter
      let rows = data.slice();
      const ft = filterType.value;
      if(ft!=='all') rows = rows.filter(r=>r.type===ft);
      if(filterMonth.value){
        const [y,m] = filterMonth.value.split('-').map(Number);
        rows = rows.filter(r=>{const d=new Date(r.date); return d.getFullYear()===y && (d.getMonth()+1)===m});
      }

      tableBody.innerHTML='';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${(new Date(r.date)).toLocaleDateString('ru-RU')}</td>
                        <td><span class="tag ${r.type==='income'?'inc':'exp'}">${r.type==='income'?'+':'-'}${formatNum(r.amount)}</span></td>
                        <td>${escapeHtml(r.category)}</td>
                        <td>${escapeHtml(r.note||'')}</td>
                        <td><button data-id="${r.id}" class="del">Удалить</button></td>`;
        tableBody.appendChild(tr);
      });

      // totals (all data or filtered?) show totals for filtered set in UI
      const income = rows.filter(r=>r.type==='income').reduce((s,r)=>s+Number(r.amount),0);
      const expense = rows.filter(r=>r.type==='expense').reduce((s,r)=>s+Number(r.amount),0);
      totalIncomeEl.textContent = formatNum(income);
      totalExpenseEl.textContent = formatNum(expense);
      balanceEl.textContent = formatNum(income - expense);

      // attach delete handlers
      document.querySelectorAll('.del').forEach(b=>b.addEventListener('click', (e)=>{
        const id = e.currentTarget.dataset.id; data = data.filter(x=>x.id!==id); save(); render();
      }));

      drawPie(rows);
    }

    function escapeHtml(s){if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

    // form
    addBtn.addEventListener('click', ()=>{
      const amount = parseFloat(amountEl.value);
      if(!amount || !categoryEl.value.trim()) return alert('Заполните сумму и категорию');
      const tx = {id: uid(), type: typeEl.value, amount: Math.abs(amount), category: categoryEl.value.trim(), note: noteEl.value.trim(), date: dateEl.value || (new Date()).toISOString()};
      addTransaction(tx);
      amountEl.value=''; categoryEl.value=''; noteEl.value=''; dateEl.value='';
    });

    // quick reports
    document.getElementById('last7').addEventListener('click', ()=>{
      const cutoff = Date.now() - 7*24*60*60*1000; filterMonth.value=''; filterType.value='all';
      const rows = data.filter(d=> new Date(d.date).getTime() >= cutoff); renderCustom(rows);
    });
    document.getElementById('last30').addEventListener('click', ()=>{
      const cutoff = Date.now() - 30*24*60*60*1000; filterMonth.value=''; filterType.value='all';
      const rows = data.filter(d=> new Date(d.date).getTime() >= cutoff); renderCustom(rows);
    });
    document.getElementById('thisMonth').addEventListener('click', ()=>{
      const now = new Date(); filterMonth.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; filterType.value='all'; render();
    });

    function renderCustom(rows){
      tableBody.innerHTML='';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${(new Date(r.date)).toLocaleDateString('ru-RU')}</td>
                        <td><span class="tag ${r.type==='income'?'inc':'exp'}">${r.type==='income'?'+':'-'}${formatNum(r.amount)}</span></td>
                        <td>${escapeHtml(r.category)}</td>
                        <td>${escapeHtml(r.note||'')}</td>
                        <td><button data-id="${r.id}" class="del">Удалить</button></td>`;
        tableBody.appendChild(tr);
      });
      const income = rows.filter(r=>r.type==='income').reduce((s,r)=>s+Number(r.amount),0);
      const expense = rows.filter(r=>r.type==='expense').reduce((s,r)=>s+Number(r.amount),0);
      totalIncomeEl.textContent = formatNum(income);
      totalExpenseEl.textContent = formatNum(expense);
      balanceEl.textContent = formatNum(income - expense);
      document.querySelectorAll('.del').forEach(b=>b.addEventListener('click', (e)=>{
        const id = e.currentTarget.dataset.id; data = data.filter(x=>x.id!==id); save(); render();
      }));
      drawPie(rows);
    }

    // export/import CSV
    exportBtn.addEventListener('click', ()=>{
      if(!data.length) return alert('Нечего экспортировать');
      const header = ['id','type','amount','category','note','date'];
      const csv = [header.join(',')].concat(data.map(r=> header.map(k=> '"'+String(r[k]||'').replace(/"/g,'""')+'"').join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'finances.csv'; a.click(); URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return; const reader = new FileReader();
      reader.onload = evt=>{
        try{
          const text = evt.target.result; const rows = text.split(/\r?\n/).filter(Boolean);
          const header = rows.shift().split(',').map(h=>h.trim().replace(/^"|"$/g,''));
          const imported = rows.map(r=>{
            const cols = parseCSVLine(r);
            const obj = {}; header.forEach((h,i)=> obj[h]=cols[i]||''); obj.amount = Number(obj.amount||0); return {...obj, id: obj.id||uid()}
          });
          data = imported.concat(data); save(); render(); alert('Импорт завершён');
        }catch(err){alert('Ошибка при импорте: '+err.message)}
      };
      reader.readAsText(f,'utf-8');
      fileInput.value='';
    });

    function parseCSVLine(line){
      const out=[]; let cur=''; let inQuotes=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i]; if(ch==='"'){ if(inQuotes && line[i+1]==='"'){cur+='"'; i++;} else {inQuotes=!inQuotes;} continue;} if(ch===',' && !inQuotes){out.push(cur); cur='';} else cur+=ch;
      }
      out.push(cur); return out;
    }

    clearBtn.addEventListener('click', ()=>{ if(confirm('Очистить все данные?')){data=[]; save(); render();}});

    // pie chart (simple)
    function drawPie(rows){
      const ctx = pieCanvas.getContext('2d');
      const w = pieCanvas.width = pieCanvas.clientWidth*devicePixelRatio;
      const h = pieCanvas.height = pieCanvas.clientHeight*devicePixelRatio;
      ctx.clearRect(0,0,w,h);
      if(!rows || !rows.length) return drawEmpty(ctx,w,h);
      // aggregate by (type + category) but we'll show expenses vs incomes and top categories for expenses
      const byCat = {};
      rows.forEach(r=>{ const key = (r.type==='expense' ? '✖ ' : '✔ ') + r.category; byCat[key] = (byCat[key] || 0) + Number(r.amount); });
      const entries = Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
      const total = entries.reduce((s,e)=>s+e[1],0);
      let start= -Math.PI/2;
      const palette = generatePalette(entries.length);
      entries.forEach(([k,v],i)=>{
        const slice = v/total * Math.PI*2;
        ctx.beginPath(); ctx.moveTo(w/2,h/2); ctx.arc(w/2,h/2, Math.min(w,h)/3, start, start+slice); ctx.closePath(); ctx.fillStyle=palette[i]; ctx.fill(); start += slice;
      });
      // legend
      ctx.font = `${12*devicePixelRatio}px system-ui`; ctx.textAlign='left'; ctx.textBaseline='middle';
      let ly = 12*devicePixelRatio;
      entries.slice(0,8).forEach(([k,v],i)=>{
        ctx.fillStyle = palette[i]; ctx.fillRect(w*0.7, ly-6*devicePixelRatio, 10*devicePixelRatio,10*devicePixelRatio);
        ctx.fillStyle = '#e6eef6'; ctx.fillText(`${k} — ${formatNum(v)}`, w*0.7 + 14*devicePixelRatio, ly);
        ly += 18*devicePixelRatio;
      });
    }
    function drawEmpty(ctx,w,h){ ctx.fillStyle='rgba(255,255,255,0.03)'; ctx.fillRect(w*0.12,h*0.2,w*0.76,h*0.6); ctx.fillStyle='#9aa6b2'; ctx.font=`${14*devicePixelRatio}px system-ui`; ctx.textAlign='center'; ctx.fillText('Нет данных', w/2, h/2); }
    function generatePalette(n){ const base=['#60a5fa','#7dd3fc','#34d399','#fbbf24','#fb7185','#a78bfa','#f472b6','#60a5fa']; const out=[]; for(let i=0;i<n;i++) out.push(base[i%base.length]); return out; }

    // initial render
    render();

    // re-render on filters change
    filterType.addEventListener('change', render);
    filterMonth.addEventListener('change', render);

    // helper: formatNum for canvas
    function formatNum(n){return (Math.round(n*100)/100).toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2})}

    // resize pie on window
    window.addEventListener('resize', ()=> render());

  </script>
</body>
</html>